**Shotgun—线上召回推送
Push_offline—线下排序分组**

### 一、	按照城市分为两组

- 在clickhouse中sql，统计了两组城市的ctr有差别，因此分成两组测试城市分组对最终ctr的影响

**Conf 中增加 [city_set]**


- city_set_A=local_ShangHai,local_GuangZhou_GuangDong,local_ShenZhen_GuangDong,local_ChengDu_SiChuan,local_ChongQing,local_HangZhou_ZheJiang,local_SuZhou_JiangSu,local_DongGuan_GuangDong,local_WuHan_HuBei,local_XiAn_ShanXi1,local_ZhengZhou_HeNan,local_NingBo_ZheJiang,local_FoShan_GuangDong,local_NanJing_JiangSu,local_QingDao_ShanDong,local_JiNan_ShanDong,local_WenZhou_ZheJiang,local_BeiJing,local_HeFei_AnHui,local_TianJin,local_WuXi_JiangSu,local_QuanZhou_GuangDong,local_KunMing_YunNan,local_FuZhou_FuJian,local_ShenYang_LiaoNing,local_XiaMen_FuJian,local_ChangSha_HuNan,local_YanTai_ShanDong,local_ChangChun_JiLin,local_TangShan_HeBei,local_XuZhou_JiangSu,local_ChangZhou_JiangSu,local_DaLian_LiaoNing,local_NanTong_JiangSu,local_YangZhou_JiangSu

- city_set_B=local_ZhenJiang_JiangSu,local_BaoJi_ShanXi1,local_LuoYang_HeNan,local_JieYang_GuangDong,local_WeiNan_ShanXi1,local_LangFang_HeBei,local_JinZhong_ShanXi,local_TongHua_JiLin,local_WuZhou_GuangXi,local_LinFen_ShanXi,local_KaiFeng_HeNan,local_HeZhou_GuangXi,local_JinHua_ZheJiang,local_GuiYang_GuiZhou,local_AKeSu_XinJiang,local_ShiJiaZhuang_HeBei,local_CangZhou_HeBei,local_QingYuan_GuangDong,local_BengBu_AnHui,local_SuiZhou_HuBei,local_YiChun_JiangXi,local_YuLin_ShanXi1,local_NanChang_JiangXi,local_AnQing_AnHui,local_YingTan_JiangXi,local_XianNing_HuBei,local_YaAn_SiChuan,local_XuanCheng_AnHui,local_HanZhong_ShanXi1,local_ZhangZhou_FuJian,local_HaErBin_HeiLongJiang,local_SuQian_JiangSu,local_BinZhou_ShanDong,local_LvLiang_ShanXi,local_HuiZhou_GuangDong,local_LiaoCheng_ShanDong,local_ZiGong_SiChuan,local_JiAn_JiangXi,local_WuHu_AnHui,local_LeShan_SiChuan,local_HanDan_HeBei,local_DaLi_YunNan,local_DongYing_ShanDong,local_QianXiNan_GuiZhou,local_TaiYuan_ShanXi,local_HuHeHaoTe_NeiMengGu,local_ChiFeng_NeiMengGu,local_WuLuMuQi_XinJiang,local_MeiShan_SiChuan,local_ZhaoQing_GuangDong,local_ZiBo_ShanDong,local_ZhaoTong_YunNan,local_ShangRao_JiangXi,local_LiuZhou_GuangXi,local_HuLunBeiEr_NeiMengGu,local_LanZhou_GanSu,local_SanMing_FuJian,local_XinZhou_ShanXi,local_JingZhou_HuBei,local_XiShuangBanNa_YunNan,local_ShaoXing_ZheJiang,local_QiQiHaEr_HeiLongJiang,local_DeZhou_ShanDong,local_JinZhou_LiaoNing,local_EErDuoSi_NeiMengGu,local_EZhou_HuBei,local_XinYang_HeNan,local_DaTong_ShanXi,local_MeiZhou_GuangDong,local_LinYi_ShanDong,local_JiuJiang_JiangXi,local_NanYang_HeNan,local_DeHong_YunNan,local_RiZhao_ShanDong,local_HuaiAn_JiangSu,local_BaoDing_HeBei,local_JiuQuan_GanSu,local_JiNing_ShanDong,local_NanNing_GuangXi,local_HaiKou_HaiNan,local_YanBian_JiLin,local_AnShan_LiaoNing,local_BaYinGuoLeng_XinJiang,local_YanAn_ShanXi1,local_XuChang_HeNan,local_NanPing_FuJian,local_NanChong_SiChuan,local_HeChi_GuangXi,local_ZhuHai_GuangDong,local_DeYang_SiChuan,local_JiaXing_ZheJiang,local_PingXiang_JiangXi,local_LiangShan_SiChuan,local_KeLaMaYi_XinJiang,local_KaShi_XinJiang,local_LiuAn_AnHui,local_XiangYang_HuBei,local_JinCheng_ShanXi,local_WeiFang_ShanDong,local_GuangAn_SiChuan,local_HengYang_HuNan,local_YiChang_HuBei,local_LianYunGang_JiangSu,local_MaAnShan_AnHui,local_QianDongNan_GuiZhou,local_ShuoZhou_ShanXi,local_AnShun_GuiZhou,local_HuLuDao_LiaoNing,local_XiNing_QingHai,local_ChongZuo_GuangXi,local_ZhuZhou_HuNan,local_YingKou_LiaoNing,local_ChaoYang_LiaoNing,local_HengShui_HeBei,local_MianYang_SiChuan,local_GanZhou_JiangXi,local_HuZhou_ZheJiang,local_BoErTaLa_XinJiang,local_ZaoZhuang_ShanDong,local_ShanWei_GuangDong,local_BaiYin_GanSu,local_ZunYi_GuiZhou,local_LiShui_ZheJiang,local_JiLin_JiLin,local_GuiLin_GuangXi,local_LuZhou_SiChuan,local_XiangTan_HuNan,local_ShangQiu_HeNan,local_HuangGang_HuBei,local_TaiZhou_ZheJiang,local_LongYan_FuJian,local_BeiHai_GuangXi,local_TianShui_GanSu,local_ZhouKou_HeNan,local_QianNan_GuiZhou,local_LinCang_YunNan,local_TaiZhou_JiangSu,local_FangChengGang_GuangXi,local_AnYang_HeNan,local_XinYu_JiangXi,local_XianYang_ShanXi1,local_BoZhou_AnHui,local_ZiYang_SiChuan,local_PuEr_YunNan,local_ShiYan_HuBei,local_LongNan_GanSu,local_FuYang_AnHui,local_QuJing_YunNan,local_ZhanJiang_GuangDong,local_LouDi_HuNan,local_ShanTou_GuangDong,local_PuTian_FuJian,local_YiBin_SiChuan,local_AnKang_ShanXi1,local_WeiHai_ShanDong,local_PanJin_LiaoNing,local_SiPing_JiLin,local_SuiNing_SiChuan,local_ZhongShan_GuangDong,local_HeZe_ShanDong,local_YongZhou_HuNan,local_ShaoGuan_GuangDong,local_YanCheng_JiangSu,local_QuZhou_ZheJiang,local_YuLin_GuangXi,local_YinChuan_NingXia,local_TaiAn_ShanDong,local_WuZhong_NingXia,local_MuDanJiang_HeiLongJiang,local_HaiNan_QingHai,local_GuangYuan_SiChuan,local_DingXi_GanSu,local_ShaoYang_HuNan,local_BaiCheng_JiLin,local_YiLi_XinJiang,local_QingYang_GanSu,local_EnShi_HuBei,local_XinXiang_HeNan,local_HongHe_YunNan,local_ZhangYe_GanSu,local_JingMen_HuBei,local_BaoTou_NeiMengGu,local_TongLiao_NeiMengGu,local_QinHuangDao_HeBei,local_HuaiHua_HuNan,local_YunFu_GuangDong,local_ChengDe_HeBei,local_SanMenXia_HeNan,local_ZhouShan_ZheJiang,local_ZhuMaDian_HeNan,local_Suihua_HeiLongJiang,local_YunCheng_ShanXi,local_XingTai_HeBei,local_ShangLuo_ShanXi1,local_HeYuan_GuangDong,local_NingDe_FuJian,local_JiangMen_GuangDong,local_LaSa_XiZang,local_TaCheng_XinJiang,local_HuaiBei_AnHui,local_XiaoGan_HuBei,local_ChangDe_HuNan,local_HuangShi_HuBei,local_ZhangJiaKou_HeBei,local_ChiZhou_AnHui,local_NeiJiang_SiChuan,local_BaiSe_GuangXi,local_JingDeZhen_JiangXi,local_MaoMing_GuangDong,local_BaoShan_YunNan,local_TieLing_LiaoNing,local_HuaiNan_AnHui,local_YangJiang_GuangDong,local_DanDong_LiaoNing,local_SongYuan_JiLin,local_PingLiang_GanSu,local_LiJiang_YunNan,local_HeBi_HeNan,local_JiaMuSi_HeiLongJiang,local_YuXi_YunNan,local_WuWei_GanSu,local_YiYang_HuNan,local_BaZhong_SiChuan,local_QinZhou_GuangXi,local_YangQuan_ShanXi,local_WenShan_YunNan,local_ChaoZhou_GuangDong,local_LuoHe_HeNan,local_DaQing_HeiLongJiang,local_ZhangJiaJie_HuNan,local_ChuXiong_YunNan,local_LiaoYang_LiaoNing,local_GuiGang_GuangXi,local_ChangJi_XinJiang,local_PuYang_HeNan,local_ShiZuiShan_NingXia,local_TongChuan_ShanXi1,local_PanZhiHua_SiChuan,local_PingDingShan_HeNan,local_XingAnMeng_NeiMengGu,local_ChuZhou_AnHui,local_DaZhou_SiChuan,local_HaMi_XinJiang,local_WuHai_NeiMengGu,local_HuangShan_AnHui,local_LiuPanShui_GuiZhou,local_LaiBin_GuangXi,local_LinZhi_XiZang,local_ChangZhi_ShanXi,local_ABa_SiChuan,local_ShuangYaShan_HeiLongJiang,local_YueYang_HuNan,local_Heihe_HeiLongJiang,local_JiaoZuo_HeNan,local_JiXi_HeiLongJiang,local_FuXin_LiaoNing,local_GanZi_SiChuan,local_ALeTai_XinJiang,local_DaXingAnLing_HeiLongJiang,local_TongLing_AnHui,local_BenXi_LiaoNing,local_FuShun_LiaoNing,local_TongRen_GuiZhou,local_ChaoHu_AnHui,local_ChenZhou_HuNan,local_DiQing_YunNan,local_LinXia_GanSu,local_BiJie_GuiZhou,local_HaiXi_QingHai,local_TuLuFan_XinJiang,local_HeGang_HeiLongJiang,local_ChangDu_XiZang,local_HeTian_XinJiang,local_ZhongWei_NingXia,local_NuJiang_YunNan,local_JinChang_GanSu,local_GanNan_GanSu,local_ShanNan_XiZang,local_GuYuan_NingXia,local_GuoLuo_QingHai,local_XiangXi_HuNan,local_HuangNan_QingHai,local_LaiWu_ShanDong,local_HaiBei_QingHai,local_HaiDong_QingHai,local_KeZiLeSu_XinJiang,local_NaQu_XiZang


 

**代码修改**

![image](https://user-images.githubusercontent.com/77714764/189300409-6ad9d06c-2395-48b4-87eb-7b2567ea8b38.png)

![image](https://user-images.githubusercontent.com/77714764/189300465-380ee686-ce14-4cd5-8cd2-01f098684010.png)

![image](https://user-images.githubusercontent.com/77714764/189300485-9df7224e-0b7c-49b0-bd70-bfcd4aaead35.png)

 
 

**### 结果**

![image](https://user-images.githubusercontent.com/77714764/189300565-a4d0d995-863e-4a85-8a4b-ed0b3d23020a.png)

 
### 结论

- 整体上在坐标轴上下浮动，有时候增长有时候降低
- 增长降低的幅度很小只有百分之几，效果不明显
- 将所有城市分成两组，每组的特征不明显，导致跟不分组差别不大

**威尔逊置信区间**

def walson_ctr(num_click, num_pv, z=1.96):
    if num_pv == 0:
        num_pv = 0.0
    p = num_click * 1.0 / num_pv
    if p > 1:
        return 1.0
    n = num_pv
    ctr_cor = (p + z**2 / (2*n) - z*(np.sqrt(p * (1-p) / n + z**2 / (4*(n**2)))))/(1 + z**2 / n)
    return ctr_cor

